# üêõ –û—Ç–ª–∞–¥–∫–∞ Kafka: –ü–æ—á–µ–º—É –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ—Ä–∑–∏–Ω–∞

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º)

```
1. –í—ã —Å–æ–∑–¥–∞–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí POST /api/auth/registration
2. user-service —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
3. user-service –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ "UserCreated" –≤ Kafka
4. Kafka —Ö—Ä–∞–Ω–∏—Ç —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –≤ —Ç–æ–ø–∏–∫–µ "users.events"
5. cart-service —á–∏—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏–∑ Kafka
6. cart-service —Å–æ–∑–¥–∞–µ—Ç –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

## –ß—Ç–æ —è –¥–æ–±–∞–≤–∏–ª –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–Ø –¥–æ–±–∞–≤–∏–ª –ª–æ–≥–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ. –¢–µ–ø–µ—Ä—å –≤—ã —É–≤–∏–¥–∏—Ç–µ:

### –í user-service:
- `üîå [USER-SERVICE] –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ Kafka...` - –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- `‚úÖ [USER-SERVICE] –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Kafka` - –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
- `üì§ [USER-SERVICE] –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–±—ã—Ç–∏–µ –≤ Kafka:` - –∫–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ
- `‚úÖ [USER-SERVICE] –°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Kafka` - –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞
- `‚ùå [USER-SERVICE] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Kafka:` - –µ—Å–ª–∏ –æ—à–∏–±–∫–∞

### –í cart-service:
- `üîå [CART-SERVICE] –ó–∞–ø—É—Å–∫–∞—é Kafka consumer...` - –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- `‚úÖ [CART-SERVICE] Kafka consumer –∑–∞–ø—É—â–µ–Ω` - –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫ —É—Å–ø–µ—à–µ–Ω
- `üì• [CART-SERVICE] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Kafka:` - –∫–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–±—ã—Ç–∏–µ
- `üîç [CART-SERVICE] –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π payload:` - —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ —Å–æ–±—ã—Ç–∏—è
- `‚úÖ [CART-SERVICE] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Å–æ–±—ã—Ç–∏–µ UserCreated` - –Ω–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `üõí [CART-SERVICE] –°–æ–∑–¥–∞—é –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è userId:` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
- `‚úÖ [CART-SERVICE] –ö–æ—Ä–∑–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞/–ø–æ–ª—É—á–µ–Ω–∞:` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### –®–∞–≥ 1: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Kafka –∑–∞–ø—É—â–µ–Ω–∞

```bash
cd /home/INTEXSOFT/ruslan.kralin/Desktop/shop-microservices/infra
docker-compose -f docker-compose.dev.yml ps
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: `kafka`, `zookeeper`

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã

**–¢–µ—Ä–º–∏–Ω–∞–ª 1 - user-service:**
```bash
cd /home/INTEXSOFT/ruslan.kralin/Desktop/shop-microservices/services/user-service
yarn start:dev
```

**–¢–µ—Ä–º–∏–Ω–∞–ª 2 - cart-service:**
```bash
cd /home/INTEXSOFT/ruslan.kralin/Desktop/shop-microservices/services/cart-service
yarn start:dev
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```bash
curl -X POST http://localhost:5000/api/auth/registration \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'
```

### –®–∞–≥ 4: –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏

**–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ user-service** –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
üì§ [USER-SERVICE] –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–±—ã—Ç–∏–µ –≤ Kafka: { topic: 'users.events', event: { type: 'UserCreated', userId: 1, ... } }
‚úÖ [USER-SERVICE] –°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Kafka
```

**–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ cart-service** –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
üì• [CART-SERVICE] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Kafka: ...
üîç [CART-SERVICE] –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π payload: { type: 'UserCreated', userId: 1, ... }
‚úÖ [CART-SERVICE] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Å–æ–±—ã—Ç–∏–µ UserCreated
üõí [CART-SERVICE] –°–æ–∑–¥–∞—é –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è userId: 1
‚úÖ [CART-SERVICE] –ö–æ—Ä–∑–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞/–ø–æ–ª—É—á–µ–Ω–∞: { id: 1, userId: 1 }
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: Kafka –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
**–°–∏–º–ø—Ç–æ–º:** `‚ùå [USER-SERVICE] –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Kafka`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
cd /home/INTEXSOFT/ruslan.kralin/Desktop/shop-microservices/infra
docker-compose -f docker-compose.dev.yml up -d
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: cart-service –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è
**–°–∏–º–ø—Ç–æ–º:** –í user-service —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –Ω–æ –≤ cart-service –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
1. cart-service –Ω–µ –∑–∞–ø—É—â–µ–Ω
2. cart-service –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ Kafka (—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å Kafka –≤ `.development.env`

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
```bash
# –í cart-service/.development.env –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
KAFKA_BROKERS=localhost:9094
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö cart-service –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞
**–°–∏–º–ø—Ç–æ–º:** `üõí [CART-SERVICE] –°–æ–∑–¥–∞—é –∫–æ—Ä–∑–∏–Ω—É...` –Ω–æ –ø–æ—Ç–æ–º –æ—à–∏–±–∫–∞ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PostgreSQL –¥–ª—è cart-service –∑–∞–ø—É—â–µ–Ω
# –í .development.env –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
DB_HOST=localhost
DB_PORT=5436
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 4: KafkaModule –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ user-service
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ user-service –ø—Ä–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `KafkaModule` –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ `AuthModule`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä–∑–∏–Ω—É:

```bash
# –ü–æ–ª—É—á–∏—Ç–µ userId –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä userId=1
curl http://localhost:5003/api/cart/user/1
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—Ç–≤–µ—Ç —Å –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–æ–π:
```json
{
  "id": 1,
  "userId": 1,
  "items": []
}
```

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ø–∏–∫–∏ –≤ Kafka:
```bash
docker exec -it kafka kafka-topics --list --bootstrap-server localhost:9092
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–æ–ø–∏–∫–µ:
```bash
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic users.events \
  --from-beginning
```

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —É–≤–∏–¥–∏—Ç–µ –ª–æ–≥–∏, –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ:
1. –ö–∞–∫–∏–µ –ª–æ–≥–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –≤ user-service
2. –ö–∞–∫–∏–µ –ª–æ–≥–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –≤ cart-service
3. –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏

–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å –≥–¥–µ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞! üéØ
